log:
  level: warn

data_providers:
  - tag: cn_ip
    file: ./geoip_cn.txt
    auto_reload: true
  - tag: ad_site
    file: ./geosite_category-ads-all.txt
    auto_reload: true
  - tag: cn_site
    file: ./geosite_cn.txt
    auto_reload: true
  - tag: ncn_site
    file: ./geosite_geolocation-!cn.txt
    auto_reload: true
  - tag: hosts
    file: ./hosts.txt
    auto_reload: true

plugins:
  - tag: hosts
    type: hosts
    args:
      hosts:
        - provider:hosts

  - tag: forward_cn
    type: fast_forward
    args:
      upstream:
        - addr: 120.53.53.5
        - addr: 121.4.4.102
  - tag: forward_not_cn
    type: fast_forward
    args:
      upstream:
        - addr: udpme://208.67.222.222
        - addr: udpme://208.67.220.220

  - tag: ecs_cn
    type: ecs
    args:
      ipv4: 61.139.2.69
      ipv6: 240e:56:4000:8000::69
      force_overwrite: true
  - tag: ecs_tw
    type: ecs
    args:
      ipv4: 168.95.1.1
      ipv6: 2001:b000:168::1
      force_overwrite: true

  - tag: cache
    type: cache
    args:
      size: 8192
      lazy_cache_ttl: 86400
      lazy_cache_reply_ttl: 1

  - tag: qtype12
    type: query_matcher
    args:
      qtype: [12]
  - tag: qtype65
    type: query_matcher
    args:
      qtype: [65]
  - tag: qtype255
    type: query_matcher
    args:
      qtype: [255]

  - tag: req_not_domain
    type: query_matcher
    args:
      domain:
        - "keyword::"
  - tag: req_ad
    type: query_matcher
    args:
      domain:
        - "provider:ad_site"
  - tag: req_cn
    type: query_matcher
    args:
      domain:
        - "provider:cn_site"
  - tag: req_not_cn
    type: query_matcher
    args:
      domain:
        - "provider:ncn_site"

  - tag: resp_cn
    type: response_matcher
    args:
      ip:
        - "provider:cn_ip"
  - tag: resp_failed
    type: response_matcher
    args:
      rcode: [2, 3]

  - tag: seq_req_cn
    type: sequence
    args:
      exec:
        - ecs_cn
        - forward_cn
  - tag: seq_req_not_cn
    type: sequence
    args:
      exec:
        - ecs_tw
        - forward_not_cn
  - tag: seq_req_unknown
    type: sequence
    args:
      exec:
        - parallel:
            - - seq_req_cn
              - if: "(! resp_cn) && [_response_valid_answer]"
                exec:
                  - _drop_response
            - - seq_req_not_cn
              - if: resp_cn
                exec:
                  - _drop_response
        - if: resp_failed
          exec:
            - seq_req_cn
  - tag: seq_req_main
    type: sequence
    args:
      exec:
        - if: req_cn
          exec:
            - seq_req_cn
            - _return
        - if: req_not_cn
          exec:
            - seq_req_not_cn
            - _return
        - seq_req_unknown

  - tag: main_sequence
    type: sequence
    args:
      exec:
        - _misc_optm
        - hosts
        # 屏蔽TYPE65与无效类型请求
        - if: "[qtype65] || (req_not_domain)"
          exec:
            - _new_nxdomain_response
            - _return
        # 优化PRT与ANY类型请求
        - if: "[qtype12] || [qtype255]"
          exec:
            - seq_req_cn
            - _return
        # 过滤广告
        - if: req_ad
          exec:
            - _new_nxdomain_response
            - _return
        - cache
        - _prefer_ipv4
        - seq_req_main

servers:
  - exec: main_sequence
    listeners:
      - protocol: udp
        addr: :53

api:
  http: 127.0.0.1:8080